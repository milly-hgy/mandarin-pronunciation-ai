<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è²éŸ» SoundPath â€” Chinese Pronunciation AI</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-zh">è²éŸ»</div>
    <div class="logo-en">SoundPath</div>
  </div>
  <nav>
    <a href="#">Learn</a>
    <a href="#">Analyze</a>
    <a href="#">Progress</a>
    <a href="#">Library</a>
    <button class="nav-cta">Start Free</button>
  </nav>
</header>

<!-- HERO -->
<section class="hero">
  <div class="hero-left">
    <div class="kicker">AI-Powered Mandarin Pronunciation</div>
    <h1 class="hero-title">Speak Mandarin<br>with <em>native</em><br>precision.</h1>
    <p class="hero-sub">Instant AI analysis for tones, initials, and finals. Visualize your pitch, pinpoint errors, and get targeted correction videos in seconds.</p>
    <div class="hero-actions">
      <button class="btn-primary" onclick="document.getElementById('upload-section').scrollIntoView({behavior:'smooth'})"><span>Analyze My Pronunciation</span></button>
    </div>
  </div>
  <div class="hero-right" style="display:none"></div>
</section>


<!-- STEP 1: RECORD / UPLOAD -->
<section class="main-section" id="upload-section">
  <div class="section-kicker">Real-time Speech Analysis</div>
  <h2 class="section-title">Speak &amp; Get<br><em>Instant</em> Feedback</h2>

  <!-- PRIMARY: STT Record Button -->
  <div class="record-primary-area">
    <button class="record-main-btn" id="recordMainBtn" onclick="startSTT()" aria-label="Start recording">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
        <line x1="12" y1="19" x2="12" y2="23"/>
        <line x1="8"  y1="23" x2="16" y2="23"/>
      </svg>
    </button>
    <div class="rp-info">
      <div class="rp-status" id="rpStatus">Tap to Record</div>
      <div class="rp-hint">Demo sentence: <span style="font-family:'Noto Serif SC',serif;color:var(--blue)">ä¸‹å€‹æ˜ŸæœŸå…­ï¼Œæˆ‘å€‘å­¸æ ¡æœ‰ä¸€å€‹éŸ³æ¨‚æœƒï¼Œå¸Œæœ›ä½ èƒ½ä¾†ã€‚</span><br><span style="font-size:10px;letter-spacing:1px;opacity:0.65">XiÃ  ge xÄ«ngqÄ«liÃ¹, wÇ’men xuÃ©xiÃ o yÇ’u yÃ­ ge yÄ«nyuÃ¨huÃ¬, xÄ«wÃ ng nÇ nÃ©ng lÃ¡i.</span></div>
      <div class="rp-result" id="rpResult"></div>
    </div>
  </div>

  <!-- SECONDARY: File Upload -->
  <div class="upload-or-divider">or upload an audio file</div>
  <label for="audioUpload">
    <div class="upload-zone" id="uploadZone">
      <div class="upload-icon"><svg viewBox="0 0 24 24"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg></div>
      <div class="upload-title">Drop your recording here</div>
      <div class="upload-sub">Supports .MP3, .WAV, .M4A, .OGG Â· Max 50MB</div>
    </div>
  </label>
  <input type="file" id="audioUpload" accept="audio/*" onchange="handleUpload(this)">
</section>

<!-- PROCESSING OVERLAY with Audio Visualizer -->
<div id="processingOverlay">
  <div class="proc-title-area">
    <div class="proc-chinese">åˆ†æä¸­</div>
    <div class="proc-subtitle">AI is analyzing your pronunciation</div>
  </div>

  <!-- â˜… Audio Visualizer â˜… -->
  <div class="av-wrap">
    <div class="av-ring"></div>
    <div class="av-ring"></div>
    <div class="audio-visualizer" id="audioVisualizer">
      <div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div>
      <div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div>
      <div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div>
      <div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div><div class="av-bar"></div>
    </div>
  </div>

  <div class="proc-steps-row">
    <div class="proc-step" id="ps1"><div class="proc-dot"></div><div class="proc-text">Transcribing with Whisper ASR</div></div>
    <div class="proc-step" id="ps2"><div class="proc-dot"></div><div class="proc-text">Extracting pitch contour (F0)</div></div>
    <div class="proc-step" id="ps3"><div class="proc-dot"></div><div class="proc-text">Detecting tone errors per syllable</div></div>
    <div class="proc-step" id="ps4"><div class="proc-dot"></div><div class="proc-text">Classifying initials & finals</div></div>
    <div class="proc-step" id="ps5"><div class="proc-dot"></div><div class="proc-text">Generating articulatory feedback</div></div>
    <div class="proc-step" id="ps6"><div class="proc-dot"></div><div class="proc-text">Matching targeted learning videos</div></div>
  </div>
</div>

<!-- STEP 3: PITCH CONTOUR -->
<section class="contour-section" id="contourSection">
  <h2 class="section-title">Your Pitch vs. <em>Native Standard</em></h2>
  <p class="contour-intro">Each graph shows your recorded F0 curve in <span style="color:#FF4500">red dashed</span> vs. the native target in <span style="color:#008080">teal</span>. Deviation zones reveal where your tone contour diverges.</p>
  <div class="contour-grid" id="contourGrid"></div>
</section>

<!-- â˜… STEP 4: SCORE BREAKDOWN â˜… -->
<section class="score-breakdown-section" id="scoreBreakdownSection">
  <div class="breakdown-card">
    <div class="breakdown-header">
      <div class="overall-score-ring">
        <div class="ring-wrapper">
          <svg class="ring-svg" viewBox="0 0 100 100">
            <defs>
              <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#4f8ef7"/>
                <stop offset="100%" style="stop-color:#38d8d8"/>
              </linearGradient>
            </defs>
            <circle class="ring-bg" cx="50" cy="50" r="40"/>
            <circle class="ring-fill" id="ringFill" cx="50" cy="50" r="40"/>
          </svg>
          <div class="ring-score-display">
            <span class="ring-score-text" id="ringScoreText">â€”</span>
          </div>
        </div>
        <div class="ring-caption">Overall Score</div>
      </div>
      <div class="breakdown-header-left">
        <div class="bd-kicker">AI Pronunciation Report</div>
        <div class="bd-title">Your Pronunciation<br>Score Breakdown</div>
        <div class="bd-sub">Detailed mastery across all phonological categories</div>
        <div class="cefr-badge" id="cefrBadge" style="background:rgba(42,95,163,0.12);color:var(--blue);border-color:rgba(42,95,163,0.30);">
          B2 | Upper-Intermediate
        </div>
        <!-- Target Sentence -->
        <div class="target-sentence">
          <div class="ts-label">What you said</div>
          <div class="ts-text" id="targetSentenceText">â€”</div>
        </div>
      </div>
    </div>

    <div class="bd-categories" id="bdCategories">

      <!-- Simple Finals (éŸ»æ¯Â·å–®éŸ»æ¯) -->
      <div class="bd-cat">
        <div class="bd-cat-label"><strong>Simple Finals</strong>å–®éŸ»æ¯</div>
        <div class="bd-bar-track"><div class="bd-bar-fill col-a" data-w="88%" id="bar-sf"></div></div>
        <div class="bd-pct high">88%</div>
        <div class="bd-badge mastered">Mastered</div>
      </div>
      <div class="bd-cat" style="margin-top:-8px">
        <div></div>
        <div class="bd-sub-items">
          <span class="bd-chip">a âœ“</span><span class="bd-chip">o âœ“</span><span class="bd-chip">e âœ“</span>
          <span class="bd-chip warn-chip">Ã¼ ~</span><span class="bd-chip">i âœ“</span><span class="bd-chip">u âœ“</span>
        </div>
      </div>

      <div class="bd-divider" style="grid-column:1/-1"></div>

      <!-- Initials (è²æ¯) -->
      <div class="bd-cat">
        <div class="bd-cat-label"><strong>Initials</strong>è²æ¯</div>
        <div class="bd-bar-track"><div class="bd-bar-fill col-b" data-w="71%" id="bar-ini"></div></div>
        <div class="bd-pct mid">71%</div>
        <div class="bd-badge improving">Improving</div>
      </div>
      <div class="bd-cat" style="margin-top:-8px">
        <div></div>
        <div class="bd-sub-items">
          <span class="bd-chip">b/p âœ“</span><span class="bd-chip">m/f âœ“</span>
          <span class="bd-chip error-chip">x/sh âœ—</span>
          <span class="bd-chip error-chip">zh/z âœ—</span>
          <span class="bd-chip">g/k âœ“</span><span class="bd-chip warn-chip">r ~</span>
          <span class="bd-chip">n/l âœ“</span>
        </div>
      </div>

      <div class="bd-divider" style="grid-column:1/-1"></div>

      <!-- Compound Finals (éŸ»æ¯Â·è¤‡éŸ»æ¯) -->
      <div class="bd-cat">
        <div class="bd-cat-label"><strong>Compound Finals</strong>è¤‡éŸ»æ¯</div>
        <div class="bd-bar-track"><div class="bd-bar-fill col-c" data-w="74%" id="bar-cf"></div></div>
        <div class="bd-pct mid">74%</div>
        <div class="bd-badge improving">Improving</div>
      </div>
      <div class="bd-cat" style="margin-top:-8px">
        <div></div>
        <div class="bd-sub-items">
          <span class="bd-chip">ai âœ“</span><span class="bd-chip">ei âœ“</span>
          <span class="bd-chip warn-chip">ao ~</span>
          <span class="bd-chip">ou âœ“</span>
          <span class="bd-chip error-chip">Ã¼e âœ—</span>
          <span class="bd-chip">ia âœ“</span><span class="bd-chip warn-chip">uo ~</span>
        </div>
      </div>

      <div class="bd-divider" style="grid-column:1/-1"></div>

      <!-- Tones (è²èª¿) -->
      <div class="bd-cat">
        <div class="bd-cat-label"><strong>Tones</strong>è²èª¿</div>
        <div class="bd-bar-track"><div class="bd-bar-fill col-d" data-w="63%" id="bar-t"></div></div>
        <div class="bd-pct low">63%</div>
        <div class="bd-badge focus">Needs Focus</div>
      </div>
      <div class="bd-cat" style="margin-top:-8px">
        <div></div>
        <div class="bd-sub-items">
          <span class="bd-chip">1st Ë‰ âœ“ 92%</span>
          <span class="bd-chip warn-chip">2nd ËŠ ~ 76%</span>
          <span class="bd-chip error-chip">3rd Ë‡ âœ— 58%</span>
          <span class="bd-chip">4th Ë‹ âœ“ 84%</span>
          <span class="bd-chip">Neutral Â· âœ“ 96%</span>
        </div>
      </div>

    </div>
  </div>
</section>

<!-- STEP 5: COLOR FEEDBACK RESULTS -->
<section class="results-section" id="resultsSection">
  <h2 class="section-title">Your Pronunciation<br><em>Breakdown</em></h2>

  <!-- Error Summary -->
  <div class="error-summary-section">
    <div class="es-header">Your Top Errors &amp; Suggestions</div>
    <div id="errorSummaryContent">
      <div class="es-item" style="border-left-color:var(--text3)">
        <div class="es-icon" style="opacity:0.4">â—Œ</div>
        <div><div class="es-label" style="color:var(--text2)">Analysis pendingâ€¦</div>
        <div class="es-tip">Record or upload audio to see personalized error analysis.</div></div>
      </div>
    </div>
  </div>

  <div class="syllable-breakdown">
    <div class="breakdown-title">Analyzed Utterance â€” Click any syllable to load a targeted video</div>
    <div class="utterance-display" id="utteranceDisplay"></div>
    <!-- Phonetic color legend -->
    <div class="ph-legend">
      <div class="ph-leg-item"><div class="ph-swatch cl-tone"></div>Tone Error</div>
      <div class="ph-leg-item"><div class="ph-swatch cl-vowel"></div>Simple Final Error</div>
      <div class="ph-leg-item"><div class="ph-swatch cl-initial"></div>Initial Error</div>
      <div class="ph-leg-item"><div class="ph-swatch cl-compound"></div>Compound Final Error</div>
    </div>
  </div>

  <!-- â”€â”€ Tone Summary Card â”€â”€ -->
  <div class="tone-summary-card">
    <div class="tone-accuracy-container">
      <div class="panel-title">Tone Accuracy</div>
      <div class="tones-grid">
        <div class="tone-row"><div class="tone-label">1st <span style="font-size:9px;opacity:0.5">Ë‰</span></div><div class="tone-bar-bg"><div class="tone-bar-fill t1" data-w="92%"></div></div><div class="tone-pct">92%</div></div>
        <div class="tone-row"><div class="tone-label">2nd <span style="font-size:9px;opacity:0.5">ËŠ</span></div><div class="tone-bar-bg"><div class="tone-bar-fill t2" data-w="76%"></div></div><div class="tone-pct">76%</div></div>
        <div class="tone-row"><div class="tone-label">3rd <span style="font-size:9px;opacity:0.5">Ë‡</span></div><div class="tone-bar-bg"><div class="tone-bar-fill t3" data-w="58%"></div></div><div class="tone-pct">58%</div></div>
        <div class="tone-row"><div class="tone-label">4th <span style="font-size:9px;opacity:0.5">Ë‹</span></div><div class="tone-bar-bg"><div class="tone-bar-fill t4" data-w="84%"></div></div><div class="tone-pct">84%</div></div>
        <div class="tone-row"><div class="tone-label">5th <span style="font-size:9px;opacity:0.5">Â·</span></div><div class="tone-bar-bg"><div class="tone-bar-fill t5" data-w="96%"></div></div><div class="tone-pct">96%</div></div>
      </div>
    </div>
    <div class="tone-contour-reference">
      <div class="panel-title">Tone Contour Reference</div>
      <div class="tone-curves">
        <div class="tone-curve-item"><svg class="tone-svg" viewBox="0 0 50 40"><line x1="8" y1="12" x2="42" y2="12" stroke="#34d8a0" stroke-width="2.5" stroke-linecap="round"/></svg><div class="tone-curve-label">1st</div></div>
        <div class="tone-curve-item"><svg class="tone-svg" viewBox="0 0 50 40"><path d="M8 30 Q25 20 42 10" stroke="#f0b429" stroke-width="2.5" fill="none" stroke-linecap="round"/></svg><div class="tone-curve-label">2nd</div></div>
        <div class="tone-curve-item"><svg class="tone-svg" viewBox="0 0 50 40"><path d="M8 15 Q20 30 25 32 Q32 30 42 12" stroke="#e8503a" stroke-width="2.5" fill="none" stroke-linecap="round"/></svg><div class="tone-curve-label">3rd</div></div>
        <div class="tone-curve-item"><svg class="tone-svg" viewBox="0 0 50 40"><path d="M8 10 Q25 20 42 32" stroke="#7eb8ff" stroke-width="2.5" fill="none" stroke-linecap="round"/></svg><div class="tone-curve-label">4th</div></div>
        <div class="tone-curve-item"><svg class="tone-svg" viewBox="0 0 50 40"><circle cx="25" cy="22" r="3" fill="#b89af8"/></svg><div class="tone-curve-label">5th</div></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ AI Feedback â€” full width â”€â”€ -->
  <div class="ai-feedback-container analysis-section" id="analysisPanel">
    <div class="panel-title">AI Feedback + Linked Videos</div>

    <!-- â”€â”€ Inline Articulatory Guide Card (updates on syllable click) â”€â”€ -->
    <div class="aic-card" id="aicCard">
      <div class="aic-header">
        <span class="aic-tag" id="aicTag">Articulatory Guide</span>
        <span class="aic-title" id="aicTitle">Click a highlighted syllable</span>
      </div>
      <div class="aic-body">
        <div class="aic-svg-col">
          <svg id="aicSvg" viewBox="0 0 160 180">
            <ellipse cx="80" cy="58" rx="52" ry="48" fill="#eef2f8" stroke="rgba(30,41,59,0.12)" stroke-width="1.5"/>
            <ellipse cx="80" cy="44" rx="11" ry="7" fill="rgba(59,130,246,0.10)" stroke="rgba(59,130,246,0.25)" stroke-width="1"/>
            <path d="M42 78 Q80 68 118 78" stroke="rgba(30,41,59,0.22)" stroke-width="1.5" fill="none"/>
            <path d="M102 78 Q112 92 108 102" stroke="rgba(30,41,59,0.20)" stroke-width="1.5" fill="none"/>
            <ellipse cx="108" cy="106" rx="4" ry="5" fill="rgba(239,68,68,0.40)"/>
            <path id="aicTonguePath" d="M32 118 Q52 108 72 108 Q92 108 108 118 L108 126 Q92 130 72 130 Q52 130 32 126 Z" fill="rgba(239,68,68,0.20)" stroke="rgba(239,68,68,0.45)" stroke-width="1.5"/>
            <ellipse id="aicTongueTip" cx="34" cy="120" rx="6" ry="4" fill="rgba(239,68,68,0.38)"/>
            <path id="aicUpperLip" d="M44 138 Q80 132 116 138 Q80 145 44 138" fill="rgba(59,130,246,0.22)" stroke="rgba(59,130,246,0.40)" stroke-width="1"/>
            <path id="aicLowerLip" d="M44 145 Q80 140 116 145 Q116 155 80 158 Q44 155 44 145" fill="rgba(59,130,246,0.22)" stroke="rgba(59,130,246,0.40)" stroke-width="1"/>
            <rect x="52" y="135" width="56" height="3" rx="1" fill="rgba(255,255,255,0.90)" stroke="rgba(30,41,59,0.12)" stroke-width="0.5"/>
            <rect x="52" y="143" width="56" height="3" rx="1" fill="rgba(255,255,255,0.90)" stroke="rgba(30,41,59,0.12)" stroke-width="0.5"/>
            <g id="aicAirFlow" opacity="0">
              <path d="M112 116 L134 116" stroke="var(--accent)" stroke-width="1.5" stroke-dasharray="3,2"/>
              <polygon points="132,113 138,116 132,119" fill="var(--accent)"/>
            </g>
            <circle id="aicHighlight" cx="80" cy="118" r="13" fill="none" stroke="var(--accent)" stroke-width="1.5" stroke-dasharray="4,3" opacity="0">
              <animate attributeName="r" values="12;16;12" dur="1.6s" repeatCount="indefinite"/>
              <animate attributeName="opacity" values="0.8;0.2;0.8" dur="1.6s" repeatCount="indefinite"/>
            </circle>
            <text x="2" y="46" font-size="6" fill="rgba(30,41,59,0.32)" font-family="monospace">nasal</text>
            <text x="2" y="80" font-size="6" fill="rgba(30,41,59,0.32)" font-family="monospace">palate</text>
            <text x="2" y="120" font-size="6" fill="rgba(30,41,59,0.32)" font-family="monospace">tongue</text>
            <text x="2" y="142" font-size="6" fill="rgba(30,41,59,0.32)" font-family="monospace">lips</text>
          </svg>
        </div>
        <div class="aic-desc" id="aicDesc">
          <div class="aic-placeholder">Click any colored syllable above or an error card below to load targeted articulatory guidance.</div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Error Feedback Cards â”€â”€ -->
    <div class="feedback-list">

      <div class="feedback-item error" id="fbNeng">
        <div class="feedback-icon error">!</div>
        <div class="feedback-content">
          <div class="feedback-title">2nd tone too flat &#8212; èƒ½ (n&#233;ng)</div>
          <div class="feedback-desc">Your rising contour plateaued at mid-pitch. The 2nd tone must rise continuously from level 3 to 5. Think: English â€œReally?â€</div>
          <div class="feedback-actions">
            <button class="anatomy-btn" id="abNeng"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>Articulatory Guide</button>
            <button class="vid-btn" id="btnNeng"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>Watch Fix</button>
          </div>
        </div>
      </div>

      <div class="feedback-item warning" id="fbXing">
        <div class="feedback-icon warning">~</div>
        <div class="feedback-content">
          <div class="feedback-title">Initial x too retracted &#8212; æ˜Ÿ (x&#299;ng)</div>
          <div class="feedback-desc">x is palatal: tongue BLADE near upper front teeth, tip stays on lower teeth. Not curled back like â€œshâ€.</div>
          <div class="feedback-actions">
            <button class="anatomy-btn" id="abXing"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>Articulatory Guide</button>
            <button class="vid-btn" id="btnXing"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>Watch Fix</button>
          </div>
        </div>
      </div>

      <div class="feedback-item warning" id="fbXiao">
        <div class="feedback-icon warning">~</div>
        <div class="feedback-content">
          <div class="feedback-title">-iao glide too short &#8212; æ ¡ (xi&#224;o)</div>
          <div class="feedback-desc">-iao needs three positions: high-front i &#8594; open a &#8594; rounded o. The a was too short and o-rounding was missing.</div>
          <div class="feedback-actions">
            <button class="anatomy-btn" id="abXiao"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>Articulatory Guide</button>
            <button class="vid-btn" id="btnXiao"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>Watch Fix</button>
          </div>
        </div>
      </div>

      <div class="feedback-item ok">
        <div class="feedback-icon ok">&#10003;</div>
        <div class="feedback-content">
          <div class="feedback-title">Great work!</div>
          <div class="feedback-desc">You mastered 17 out of 20 syllables! Words like â€˜ä¸‹â€™, â€˜å…­â€™, and â€˜å­¸â€™ sound perfectly natural.</div>
        </div>
      </div>

    </div>
  </div>

</section>

<!-- VIDEO SECTION â€” YouTube Intervention -->
<section class="video-section" id="videoSection">
  <div class="section-kicker">Automated Remedial Video System</div>
  <h2 class="section-title">Videos Matched<br>to Your <em>Errors</em></h2>
  <div class="yt-outer">
    <div class="yt-caption" id="videoCaption">Record your pronunciation above to load a targeted correction video.</div>
    <div class="yt-wrap">
      <!-- Placeholder shown until a video loads -->
      <div class="yt-placeholder" id="ytPlaceholder">
        <div class="yt-ph-icon">
          <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        </div>
        <span>Your personalised video will appear here<br>after pronunciation analysis</span>
      </div>
      <iframe id="ytPlayer"
        src="about:blank"
        allow="autoplay; encrypted-media; fullscreen"
        allowfullscreen
        style="opacity:0;transition:opacity 0.5s ease;"
        onload="this.style.opacity=(this.src!=='about:blank'?'1':'0');document.getElementById('ytPlaceholder').style.display=(this.src!=='about:blank'?'none':'flex')">
      </iframe>
    </div>
  </div>
</section>


<!-- ANATOMY MODAL -->
<div id="anatomyModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeAnatomy()">âœ•</button>
    <div class="modal-header">
      <div class="modal-tag" id="modalTag">Articulatory Guide</div>
      <div class="modal-title" id="modalTitle">Loading...</div>
      <div class="modal-sub" id="modalSub">Cross-section animation</div>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div>
          <div class="anatomy-svg-wrap">
            <svg id="anatomySvg" viewBox="0 0 240 270">
              <ellipse cx="120" cy="88" rx="78" ry="72" fill="rgba(7,20,40,0.8)" stroke="rgba(79,142,247,0.3)" stroke-width="1.5"/>
              <ellipse cx="120" cy="68" rx="16" ry="10" fill="rgba(79,142,247,0.12)" stroke="rgba(79,142,247,0.2)" stroke-width="1"/>
              <path d="M98 60 Q120 42 142 60" fill="none" stroke="rgba(79,142,247,0.2)" stroke-width="1"/>
              <rect x="76" y="118" width="88" height="52" rx="8" fill="rgba(232,80,58,0.25)"/>
              <path d="M82 120 Q120 110 158 120" stroke="rgba(126,184,255,0.5)" stroke-width="2" fill="none"/>
              <path id="softPalate" d="M148 120 Q162 136 156 150" stroke="rgba(126,184,255,0.4)" stroke-width="2" fill="none"/>
              <ellipse id="uvula" cx="154" cy="154" rx="5" ry="7" fill="rgba(232,80,58,0.6)"/>
              <g id="tongueGroup">
                <path id="tonguePath" d="M80 168 Q102 153 132 153 Q156 153 162 166 L162 176 Q155 181 132 181 Q102 181 80 176 Z" fill="rgba(232,80,58,0.5)" stroke="rgba(232,80,58,0.7)" stroke-width="1"/>
                <ellipse id="tongueTip" cx="83" cy="170" rx="8" ry="5" fill="rgba(232,80,58,0.7)"/>
              </g>
              <path id="upperLip" d="M90 196 Q120 190 150 196 Q120 204 90 196" fill="rgba(79,142,247,0.4)" stroke="rgba(79,142,247,0.5)" stroke-width="1"/>
              <path id="lowerLip" d="M90 204 Q120 198 150 204 Q150 216 120 219 Q90 216 90 204" fill="rgba(79,142,247,0.4)" stroke="rgba(79,142,247,0.5)" stroke-width="1"/>
              <rect x="96" y="193" width="48" height="5" rx="2" fill="rgba(255,255,255,0.8)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
              <rect x="96" y="204" width="48" height="5" rx="2" fill="rgba(255,255,255,0.8)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
              <g id="airFlow" opacity="0">
                <path d="M165 160 L188 160" stroke="var(--accent)" stroke-width="2" stroke-dasharray="4,3"/>
                <polygon points="186,156 194,160 186,164" fill="var(--accent)"/>
                <text x="170" y="155" font-size="8" fill="var(--accent)" font-family="monospace">air</text>
              </g>
              <circle id="highlightCircle" cx="120" cy="160" r="18" fill="none" stroke="var(--accent)" stroke-width="2" stroke-dasharray="5,3" opacity="0">
                <animate attributeName="r" values="17;22;17" dur="1.6s" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.9;0.3;0.9" dur="1.6s" repeatCount="indefinite"/>
              </circle>
              <text x="8" y="70" font-size="8" fill="rgba(126,184,255,0.6)" font-family="monospace">nasal</text>
              <text x="8" y="128" font-size="8" fill="rgba(126,184,255,0.6)" font-family="monospace">palate</text>
              <text x="8" y="168" font-size="8" fill="rgba(126,184,255,0.6)" font-family="monospace">tongue</text>
              <text x="8" y="204" font-size="8" fill="rgba(126,184,255,0.6)" font-family="monospace">lips</text>
            </svg>
          </div>
        </div>
        <div>
          <div class="anatomy-steps" id="anatomySteps"></div>
          <div class="modal-controls">
            <button class="ctrl-btn ghost" onclick="prevAnatStep()">â† Prev</button>
            <button class="ctrl-btn" onclick="nextAnatStep()">Next â†’</button>
            <span class="step-indicator" id="stepIndicator">1 / 3</span>
          </div>
          <a class="modal-video-link" onclick="alert('Opening linked tutorial video...')">
            <div class="mvl-icon"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg></div>
            <div>
              <div class="mvl-label">Watch Tutorial</div>
              <div class="mvl-title" id="modalVideoTitle">Loading...</div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3/dist/index.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATIC DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* Demo sentence: ä¸‹å€‹æ˜ŸæœŸå…­ï¼Œæˆ‘å€‘å­¸æ ¡æœ‰ä¸€å€‹éŸ³æ¨‚æœƒï¼Œå¸Œæœ›ä½ èƒ½ä¾†ã€‚
   Pinyin: XiÃ  ge xÄ«ngqÄ«liÃ¹, wÇ’men xuÃ©xiÃ o yÇ’u yÃ­ ge yÄ«nyuÃ¨huÃ¬, xÄ«wÃ ng nÇ nÃ©ng lÃ¡i. */
const SYLLABLES = [
  {char:'ä¸‹', pinyin:'xiÃ ',  type:'correct',        tooltip:'âœ“ Correct â€” 4th tone'},
  {char:'å€‹', pinyin:'ge',   type:'correct',        tooltip:'âœ“ Correct â€” neutral tone'},
  {char:'æ˜Ÿ', pinyin:'xÄ«ng', type:'initial-error',  tooltip:'âš  Initial Error: x â€” tongue blade too retracted (j/q/x group)',
    anatomyKey:'xsh',
    videoSrc:'https://www.youtube.com/embed/05BMKdxHjp8?start=33',
    videoLabel:'æ˜Ÿ (xÄ«ng) â€” Initial x: tongue blade position (j/q/x group)'},
  {char:'æœŸ', pinyin:'qÄ«',   type:'correct',        tooltip:'âœ“ Correct â€” 1st tone'},
  {char:'å…­', pinyin:'liÃ¹',  type:'correct',        tooltip:'âœ“ Correct â€” 4th tone'},
  {char:'æˆ‘', pinyin:'wÇ’',   type:'correct',        tooltip:'âœ“ Correct â€” 3rd tone'},
  {char:'å€‘', pinyin:'men',  type:'correct',        tooltip:'âœ“ Correct â€” neutral tone'},
  {char:'å­¸', pinyin:'xuÃ©',  type:'correct',        tooltip:'âœ“ Correct â€” 2nd tone'},
  {char:'æ ¡', pinyin:'xiÃ o', type:'compound-error', tooltip:'âš  Compound Final Error: -iao glide needs tighter lip rounding',
    anatomyKey:'iao',
    videoSrc:'https://www.youtube.com/embed/IwXyiWNv1Ts?start=260',
    videoLabel:'æ ¡ (xiÃ o) â€” Compound Final: -iao vowel glide & lip shape'},
  {char:'æœ‰', pinyin:'yÇ’u',  type:'correct',        tooltip:'âœ“ Correct â€” 3rd tone'},
  {char:'ä¸€', pinyin:'yÄ«',   type:'correct',        tooltip:'âœ“ Correct â€” 1st tone'},
  {char:'å€‹', pinyin:'gÃ¨',   type:'correct',        tooltip:'âœ“ Correct â€” 4th tone'},
  {char:'éŸ³', pinyin:'yÄ«n',  type:'correct',        tooltip:'âœ“ Correct â€” 1st tone'},
  {char:'æ¨‚', pinyin:'yuÃ¨',  type:'correct',        tooltip:'âœ“ Correct â€” 4th tone'},
  {char:'æœƒ', pinyin:'huÃ¬',  type:'correct',        tooltip:'âœ“ Correct â€” 4th tone'},
  {char:'å¸Œ', pinyin:'xÄ«',   type:'correct',        tooltip:'âœ“ Correct â€” 1st tone'},
  {char:'æœ›', pinyin:'wÃ ng', type:'correct',        tooltip:'âœ“ Correct â€” 4th tone'},
  {char:'ä½ ', pinyin:'nÇ',   type:'correct',        tooltip:'âœ“ Correct â€” 3rd tone'},
  {char:'èƒ½', pinyin:'nÃ©ng', type:'tone-error',     tooltip:'âœ— Tone Error: 2nd tone too flat â€” contour should rise sharply (35â†’55)',
    anatomyKey:'tone2',
    videoSrc:'https://www.youtube.com/embed/n_Cj3aOSI1w?start=433',
    videoLabel:'èƒ½ (nÃ©ng) â€” Tone Error: 2nd tone (rising) pitch correction'},
  {char:'ä¾†', pinyin:'lÃ¡i',  type:'correct',        tooltip:'âœ“ Correct â€” 2nd tone'},
];

/* Full-sentence pitch data for ä¸‹å€‹æ˜ŸæœŸå…­ï¼Œæˆ‘å€‘å­¸æ ¡æœ‰ä¸€å€‹éŸ³æ¨‚æœƒï¼Œå¸Œæœ›ä½ èƒ½ä¾†ã€‚ */
const SENTENCE_PITCH = [
  {char:'ä¸‹', pinyin:'xiÃ ',  tone:4, native:[.92,.82,.68,.52,.40,.28,.18,.10], user:[.90,.80,.66,.50,.38,.27,.17,.09]},
  {char:'å€‹', pinyin:'ge',   tone:0, native:[.44,.43,.43,.42,.42,.42,.41,.41], user:[.43,.43,.42,.42,.41,.41,.40,.40]},
  {char:'æ˜Ÿ', pinyin:'xÄ«ng', tone:1, native:[.82,.82,.82,.82,.82,.82,.82,.82], user:[.77,.78,.78,.77,.77,.78,.77,.77], error:'initial-error'},
  {char:'æœŸ', pinyin:'qÄ«',   tone:1, native:[.82,.82,.82,.82,.82,.82,.82,.82], user:[.81,.82,.81,.82,.81,.82,.81,.82]},
  {char:'å…­', pinyin:'liÃ¹',  tone:4, native:[.92,.82,.68,.52,.40,.28,.18,.10], user:[.91,.81,.67,.51,.39,.27,.17,.10]},
  {char:'æˆ‘', pinyin:'wÇ’',   tone:3, native:[.55,.38,.18,.10,.08,.25,.52,.72], user:[.53,.36,.17,.09,.08,.24,.50,.70]},
  {char:'å€‘', pinyin:'men',  tone:0, native:[.44,.43,.43,.42,.42,.42,.41,.41], user:[.44,.43,.43,.42,.41,.41,.41,.40]},
  {char:'å­¸', pinyin:'xuÃ©',  tone:2, native:[.28,.38,.50,.62,.72,.82,.88,.93], user:[.29,.39,.51,.62,.72,.82,.88,.93]},
  {char:'æ ¡', pinyin:'xiÃ o', tone:4, native:[.92,.82,.68,.52,.40,.28,.18,.10], user:[.88,.78,.64,.50,.40,.32,.25,.20], error:'compound-error'},
  {char:'æœ‰', pinyin:'yÇ’u',  tone:3, native:[.55,.38,.18,.10,.08,.25,.52,.72], user:[.54,.37,.18,.10,.08,.24,.51,.71]},
  {char:'ä¸€', pinyin:'yÄ«',   tone:1, native:[.82,.82,.82,.82,.82,.82,.82,.82], user:[.82,.82,.82,.82,.82,.82,.82,.82]},
  {char:'å€‹', pinyin:'gÃ¨',   tone:4, native:[.92,.82,.68,.52,.40,.28,.18,.10], user:[.91,.81,.67,.51,.39,.27,.18,.10]},
  {char:'éŸ³', pinyin:'yÄ«n',  tone:1, native:[.82,.82,.82,.82,.82,.82,.82,.82], user:[.82,.82,.82,.82,.82,.82,.82,.82]},
  {char:'æ¨‚', pinyin:'yuÃ¨',  tone:4, native:[.92,.82,.68,.52,.40,.28,.18,.10], user:[.91,.81,.67,.51,.39,.27,.18,.10]},
  {char:'æœƒ', pinyin:'huÃ¬',  tone:4, native:[.92,.82,.68,.52,.40,.28,.18,.10], user:[.91,.81,.67,.51,.39,.27,.17,.09]},
  {char:'å¸Œ', pinyin:'xÄ«',   tone:1, native:[.82,.82,.82,.82,.82,.82,.82,.82], user:[.81,.82,.81,.82,.81,.82,.81,.82]},
  {char:'æœ›', pinyin:'wÃ ng', tone:4, native:[.92,.82,.68,.52,.40,.28,.18,.10], user:[.91,.81,.67,.51,.39,.27,.18,.10]},
  {char:'ä½ ', pinyin:'nÇ',   tone:3, native:[.55,.38,.18,.10,.08,.25,.52,.72], user:[.54,.37,.17,.09,.08,.24,.50,.71]},
  {char:'èƒ½', pinyin:'nÃ©ng', tone:2, native:[.28,.38,.50,.62,.72,.82,.88,.93], user:[.28,.32,.36,.40,.44,.50,.56,.62], error:'tone-error'},
  {char:'ä¾†', pinyin:'lÃ¡i',  tone:2, native:[.28,.38,.50,.62,.72,.82,.88,.93], user:[.29,.39,.51,.62,.72,.82,.88,.93]},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIDEO MAP â€” YouTube IDs + Start Times
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const VIDEO_MAP = {
  simpleFinals: {
    videoId: 'zgTmdJXNfNY',
    phonemes: { a:115, o:149, e:203, i:257, u:300, 'Ã¼':347 }
  },
  initials: {
    bpmf:    { videoId: 'P73V1Qh9K10', phonemes: { b:114, p:167, m:239, f:257 } },
    dtnl:    { videoId: 'q-Wxb-hgCNc', phonemes: { d:340, t:358, n:395, l:423 } },
    gkh:     { videoId: 'ohDuo4bDqlI', phonemes: { g:73,  k:130, h:168 } },
    jqx:     { videoId: '05BMKdxHjp8', phonemes: { j:118, q:187, x:33 } },
    zcs:     { videoId: '-69O93VF404', phonemes: { z:119, c:182, s:32 } },
    zhchshr: { videoId: 'dpQ3IMd4AMg', phonemes: { zh:144, ch:227, sh:71, r:298 } }
  },
  compoundFinals: {
    videoId: 'IwXyiWNv1Ts',
    phonemes: { ai:167, ei:167, ao:167, ou:167, ie:211, 'Ã¼e':211, er:211, an:228, en:228, 'in':228 }
  },
  tones: {
    videoId: 'n_Cj3aOSI1w',
    phonemes: { tone1:134, tone2:433, tone3:189, tone4:501, neutral:571 }
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PINYIN DICTIONARY (common characters)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PINYIN_DICT = {
  'æˆ‘':'wÇ’','ä½ ':'nÇ','ä»–':'tÄ','å¥¹':'tÄ','å®ƒ':'tÄ','ä»¬':'men','å¥½':'hÇo','æ˜¯':'shÃ¬',
  'çš„':'de','äº†':'le','åœ¨':'zÃ i','æœ‰':'yÇ’u','è¿™':'zhÃ¨','é‚£':'nÃ ','ä¸ª':'gÃ¨','äºº':'rÃ©n',
  'å¤§':'dÃ ','å°':'xiÇo','ä¸­':'zhÅng','å›½':'guÃ³','å­¦':'xuÃ©','ç”Ÿ':'shÄ“ng','è€':'lÇo',
  'å¸ˆ':'shÄ«','æ¥':'lÃ¡i','å»':'qÃ¹','è¯´':'shuÅ','è¯':'huÃ ','å¬':'tÄ«ng','çœ‹':'kÃ n',
  'æƒ³':'xiÇng','æ™®':'pÇ”','é€š':'tÅng','å‘':'fÄ','éŸ³':'yÄ«n','æ±‰':'hÃ n','è¯­':'yÇ”',
  'è°¢':'xiÃ¨','ä¸':'bÃ¹','è¦':'yÃ o','åƒ':'chÄ«','å–':'hÄ“','é¥­':'fÃ n','æ°´':'shuÇ',
  'èŒ¶':'chÃ¡','å¾ˆ':'hÄ›n','çœŸ':'zhÄ“n','å¯¹':'duÃ¬','å—':'ma','å‘¢':'ne','å•Š':'a',
  'ä¸Š':'shÃ ng','ä¸‹':'xiÃ ','é‡Œ':'lÇ','å‰':'qiÃ¡n','å':'hÃ²u','å·¦':'zuÇ’','å³':'yÃ²u',
  'å¤š':'duÅ','å°‘':'shÇo','ä¸€':'yÄ«','äºŒ':'Ã¨r','ä¸‰':'sÄn','å››':'sÃ¬','äº”':'wÇ”',
  'å¹´':'niÃ¡n','æœˆ':'yuÃ¨','å¤©':'tiÄn','ä»Š':'jÄ«n','æ˜':'mÃ­ng','æ—©':'zÇo','æ™š':'wÇn',
  'èµ°':'zÇ’u','è·‘':'pÇo','å':'zuÃ²','ç«™':'zhÃ n','å¼€':'kÄi','ç”¨':'yÃ²ng','åš':'zuÃ²',
  'çˆ±':'Ã i','å–œ':'xÇ','æ¬¢':'huÄn','é«˜':'gÄo','å…´':'xÃ¬ng','å¿«':'kuÃ i','ä¹':'lÃ¨',
  'è¯·':'qÇng','é—®':'wÃ¨n','ç­”':'dÃ¡','è¯»':'dÃº','å†™':'xiÄ›','ä¹¦':'shÅ«','å­—':'zÃ¬',
  'å':'mÃ­ng','å«':'jiÃ o','ä½':'zhÃ¹','å®¶':'jiÄ','æœ‹':'pÃ©ng','å‹':'yÇ’u','è€':'lÇo'
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STT STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let sttRecognized   = '';
let activeRecognition = null;
let isListening     = false;
let currentSyllables = SYLLABLES;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCORE â†’ CEFR LEVEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function scoreToLevel(score) {
  if (score >= 96) return { level:'C2', label:'Mastery',            color:'#38d8d8' };
  if (score >= 86) return { level:'C1', label:'Proficient',         color:'#34d8a0' };
  if (score >= 71) return { level:'B2', label:'Upper-Intermediate', color:'#4f8ef7' };
  if (score >= 56) return { level:'B1', label:'Intermediate',       color:'#f0b429' };
  if (score >= 41) return { level:'A2', label:'Elementary',         color:'#f07848' };
  return              { level:'A1', label:'Beginner',           color:'#e8503a' };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REAL-TIME STT (Web Speech API)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startSTT() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    alert('Speech recognition is not supported in this browser.\nPlease use Chrome or Edge.\n\nFalling back to demo mode.');
    runDemo();
    return;
  }

  // Toggle off if already listening
  if (isListening) {
    if (activeRecognition) activeRecognition.stop();
    return;
  }

  const recognition   = new SR();
  activeRecognition   = recognition;
  recognition.lang           = 'zh-CN';
  recognition.continuous     = false;
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;

  isListening = true;
  const btn  = document.getElementById('recordMainBtn');
  const stat = document.getElementById('rpStatus');
  const res  = document.getElementById('rpResult');

  btn.classList.add('listening');
  stat.textContent = 'â— Listeningâ€¦ speak now';
  res.textContent  = '';
  sttRecognized    = '';

  recognition.onresult = (e) => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
    res.textContent = transcript;
    if (e.results[e.results.length - 1].isFinal) {
      sttRecognized = transcript;
    }
  };

  recognition.onend = () => {
    isListening = false;
    btn.classList.remove('listening');
    if (sttRecognized) {
      stat.textContent = 'âœ“ Captured â€” running AI analysisâ€¦';
      // Immediately update Target Sentence display
      const tse = document.getElementById('targetSentenceText');
      if (tse) tse.textContent = sttRecognized;
      // Show captured text in upload zone
      const zone = document.getElementById('uploadZone');
      zone.innerHTML = `
        <div class="upload-icon" style="background:rgba(52,216,160,0.2)">
          <svg viewBox="0 0 24 24" style="width:24px;height:24px;stroke:var(--jade);fill:none;stroke-width:2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="upload-title" style="font-family:'Noto Serif SC',serif;font-size:24px;letter-spacing:3px">"${sttRecognized}"</div>
        <div class="upload-sub">Speech captured Â· Phonetic analysis in progressâ€¦</div>`;
      setFlowStep(2);
      setTimeout(runProcessing, 400);
    } else {
      stat.textContent = 'Tap to Record';
      res.textContent  = 'No speech detected â€” try again.';
    }
  };

  recognition.onerror = (e) => {
    isListening = false;
    btn.classList.remove('listening');
    if (e.error === 'not-allowed') {
      alert('Microphone access was denied.\nPlease allow microphone access in your browser settings and try again.');
    } else {
      const stat2 = document.getElementById('rpStatus');
      if (stat2) stat2.textContent = 'Error: ' + e.error + ' â€” tap to retry';
    }
  };

  recognition.start();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PINYIN â†’ COLORED HTML
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPinyinColored(pinyin) {
  const TONE_CHARS = new Set('ÄÃ¡ÇÃ ÅÃ³Ç’Ã²Ä“Ã©Ä›Ã¨Ä«Ã­ÇÃ¬Å«ÃºÇ”Ã¹Ç–Ç˜ÇšÇœ'.split(''));
  const PLAIN_VOWELS = new Set('aoeiu'.split(''));
  const INITIALS = ['zh','ch','sh','b','p','m','f','d','t','n','l','g','k','h','j','q','x','z','c','s','r','y','w'];
  const toneBase  = {Ä:'a',Ã¡:'a',Ç:'a',Ã :'a',Å:'o',Ã³:'o',Ç’:'o',Ã²:'o',Ä“:'e',Ã©:'e',Ä›:'e',Ã¨:'e',Ä«:'i',Ã­:'i',Ç:'i',Ã¬:'i',Å«:'u',Ãº:'u',Ç”:'u',Ã¹:'u',Ç–:'Ã¼',Ç˜:'Ã¼',Çš:'Ã¼',Çœ:'Ã¼'};

  let str = pinyin;
  let html = '';

  // 1. Extract initial
  let iniStr = '';
  for (const ini of INITIALS) {
    if (str.toLowerCase().startsWith(ini)) {
      iniStr = str.slice(0, ini.length);
      str    = str.slice(ini.length);
      break;
    }
  }
  if (iniStr) html += `<span class="ph-initial">${iniStr}</span>`;

  // 2. Classify the final (compound if > 1 base char)
  const baseStr   = str.split('').map(c => toneBase[c] || c).join('');
  const isCompound = baseStr.length > 1;

  // 3. Render each character of the final
  for (let i = 0; i < str.length; i++) {
    const ch = str[i];
    if (TONE_CHARS.has(ch)) {
      html += `<span class="ph-tone">${ch}</span>`;
    } else if (PLAIN_VOWELS.has(ch) || ch === 'Ã¼') {
      html += isCompound
        ? `<span class="ph-compound">${ch}</span>`
        : `<span class="ph-simple">${ch}</span>`;
    } else {
      // Coda consonant (n, ng, r â€¦)
      html += `<span class="ph-compound">${ch}</span>`;
    }
  }

  return html || `<span>${pinyin}</span>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD SYLLABLES FROM STT TEXT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSyllablesFromSTT(text) {
  const chars = [...text].filter(c => /[\u4e00-\u9fff]/.test(c));
  if (chars.length === 0) return SYLLABLES;

  // Weighted error distribution (realistic simulation)
  const errorPool = [
    'correct','correct','correct','correct',
    'tone-error','tone-error',
    'initial-error',
    'vowel-error'
  ];
  const tooltipMap = {
    'correct':       'âœ“ Correct',
    'tone-error':    'âœ— Tone Error: pitch contour deviated from target',
    'initial-error': 'âš  Initial Error: consonant articulation needs adjustment',
    'vowel-error':   'âš  Simple Final Error: vowel shape or lip position incorrect'
  };

  return chars.slice(0, 10).map((char, i) => {
    let pinyin;
    if (window.pinyinPro) {
      // Dynamic conversion via pinyin-pro â€” works for any Chinese character
      const result = window.pinyinPro.pinyin(char, { toneType: 'symbol', type: 'array' });
      pinyin = (result && result[0]) || PINYIN_DICT[char] || '?';
    } else {
      // Static dictionary fallback (used if CDN is unavailable)
      pinyin = PINYIN_DICT[char] || '?';
    }
    const type = errorPool[i % errorPool.length];
    return { char, pinyin, type, tooltip: tooltipMap[type] };
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ERROR SUMMARY BUILDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildErrorSummary(syllables) {
  const container = document.getElementById('errorSummaryContent');
  if (!container) return;

  const toneErrs    = syllables.filter(s => s.type === 'tone-error');
  const initialErrs = syllables.filter(s => s.type === 'initial-error');
  const vowelErrs   = syllables.filter(s => s.type === 'vowel-error');
  const items       = [];

  if (toneErrs.length)
    items.push({
      color:'#e8503a', icon:'ğŸ”´',
      label:`Tone Errors â€” <span style="font-family:'Noto Serif SC',serif;font-size:14px">${toneErrs.map(s=>s.char).join(' ')}</span>`,
      tip:'Your pitch contour deviates from the target tone. Practise the 214 dip for 3rd tone and hold the level for 1st tone.'
    });
  if (initialErrs.length)
    items.push({
      color:'#f1c40f', icon:'ğŸŸ¡',
      label:`Initial Consonant Errors â€” <span style="font-family:'Noto Serif SC',serif;font-size:14px">${initialErrs.map(s=>s.char).join(' ')}</span>`,
      tip:'Tongue and lip positioning for these initials needs attention. Contrast pairs like x/sh and z/zh slowly in a mirror.'
    });
  if (vowelErrs.length)
    items.push({
      color:'#9b59b6', icon:'ğŸŸ£',
      label:`Simple Final Errors â€” <span style="font-family:'Noto Serif SC',serif;font-size:14px">${vowelErrs.map(s=>s.char).join(' ')}</span>`,
      tip:'Mouth opening shape or lip rounding needs adjustment. For Ã¼: hold "ee" tongue position while rounding lips tightly.'
    });

  if (items.length === 0) {
    container.innerHTML = `
      <div class="es-item" style="border-left-color:var(--jade)">
        <div class="es-icon">âœ…</div>
        <div>
          <div class="es-label" style="color:var(--jade)">Excellent Pronunciation!</div>
          <div class="es-tip">No major errors detected in this recording. Keep practising for native-level refinement.</div>
        </div>
      </div>`;
    return;
  }

  container.innerHTML = items.map(it => `
    <div class="es-item" style="border-left-color:${it.color}">
      <div class="es-icon">${it.icon}</div>
      <div>
        <div class="es-label" style="color:${it.color}">${it.label}</div>
        <div class="es-tip">${it.tip}</div>
      </div>
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIDEO INTERVENTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateVideoIntervention(errorType, phoneme) {
  let videoId = null, startTime = 0, displayLabel = String(phoneme);

  if (errorType === 'tone') {
    const key  = (typeof phoneme === 'number') ? 'tone' + phoneme : phoneme;
    videoId    = VIDEO_MAP.tones.videoId;
    startTime  = VIDEO_MAP.tones.phonemes[key] || VIDEO_MAP.tones.phonemes.tone3;
    displayLabel = 'Tone ' + phoneme;
  } else if (errorType === 'simpleFinal') {
    videoId    = VIDEO_MAP.simpleFinals.videoId;
    startTime  = VIDEO_MAP.simpleFinals.phonemes[phoneme] || 115;
  } else if (errorType === 'compoundFinal') {
    videoId    = VIDEO_MAP.compoundFinals.videoId;
    startTime  = VIDEO_MAP.compoundFinals.phonemes[phoneme] || 167;
  } else if (errorType === 'initial') {
    for (const group of Object.values(VIDEO_MAP.initials)) {
      if (phoneme in group.phonemes) {
        videoId   = group.videoId;
        startTime = group.phonemes[phoneme];
        break;
      }
    }
  }

  if (!videoId) return;

  const iframe  = document.getElementById('ytPlayer');
  const caption = document.getElementById('videoCaption');
  const ph      = document.getElementById('ytPlaceholder');

  if (iframe) {
    iframe.src = `https://www.youtube.com/embed/${videoId}?start=${startTime}&autoplay=0`;
  }
  if (caption) {
    caption.textContent = `Recommended for you: Practice your "${displayLabel}" technique.`;
  }
  if (ph) ph.style.display = 'none';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPER: extract initial from pinyin
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function extractInitial(pinyin) {
  const INITIALS = ['zh','ch','sh','b','p','m','f','d','t','n','l','g','k','h','j','q','x','z','c','s','r'];
  for (const ini of INITIALS) {
    if (pinyin.toLowerCase().startsWith(ini)) return ini;
  }
  return null;
}

const ANATOMY = {
  /* â”€â”€ 2nd Tone (Rising) â€” èƒ½ nÃ©ng â”€â”€ */
  tone2:{
    tag:'Tone Error Â· 2nd Tone',title:'Rising é™½å¹³ (35)',
    sub:'Start low at 3, rise steadily to 5. Your contour was too flat.',
    videoTitle:'2nd Tone Rising Contour â€” n_Cj3aOSI1w (7:13)',
    videoSrc:'https://www.youtube.com/embed/n_Cj3aOSI1w?start=433',
    steps:[
      {title:'Start Low â€” Pitch Level 3',text:'Begin from a mid-low pitch (about 35% of your range). Resist the urge to start flat. The low starting point is what distinguishes this from the 1st tone.'},
      {title:'Rise Continuously to Level 5',text:'Keep pushing your pitch upward without any dip or plateau. Think of it as a question in English: "Really?". The rise should be energetic and sustained for the full duration of the syllable.'},
      {title:'Practise with Contrast',text:'Alternate "mÄo (1st) â€” mÃ¡o (2nd) â€” mÇo (3rd) â€” mÃ o (4th)". Feel the difference in the starting pitch and trajectory. Record yourself and compare your F0 curve to the native standard above.'},
    ],
    svg:(s)=>{
      const tp=document.getElementById('tonguePath'),hl=document.getElementById('highlightCircle');
      hl.setAttribute('opacity','0.7');
      if(s===0){hl.setAttribute('cx',120);hl.setAttribute('cy',180);tp.setAttribute('d','M80 170 Q102 155 132 155 Q156 155 162 167 L162 177 Q155 182 132 182 Q102 182 80 177 Z');}
      else if(s===1){hl.setAttribute('cx',120);hl.setAttribute('cy',90);tp.setAttribute('d','M80 168 Q102 152 132 152 Q156 152 162 165 L162 175 Q155 180 132 180 Q102 180 80 175 Z');}
      else{hl.setAttribute('cx',120);hl.setAttribute('cy',130);tp.setAttribute('d','M80 169 Q102 153 132 153 Q156 153 162 166 L162 176 Q155 181 132 181 Q102 181 80 176 Z');}
    }
  },
  /* â”€â”€ -iao Compound Final â€” æ ¡ xiÃ o â”€â”€ */
  iao:{
    tag:'Compound Final Error Â· -iao',title:'-iao Glide: Lip & Tongue Shape',
    sub:'Open wide on -a, then glide smoothly to rounded -o.',
    videoTitle:'-iao Compound Final â€” IwXyiWNv1Ts (4:20)',
    videoSrc:'https://www.youtube.com/embed/IwXyiWNv1Ts?start=260',
    steps:[
      {title:'Start with a High Tongue â€” "ee" (i)',text:'Begin with the tongue high and front, mouth slightly open, as if saying "ee" (yÄ«). This is the on-glide. Many learners skip this and start too open.'},
      {title:'Drop Wide Open on "ah" (a)',text:'From the high-front position, immediately open the jaw wide and lower the tongue to the central-low "ah" position. This should be the most prominent, loudest part of the syllable.'},
      {title:'Glide to Rounded "oh" (o)',text:'Without pausing, round the lips into a small circle and raise the back of the tongue for the off-glide "o". The movement should be fluid. Practise: "i-ah-oh" merging into one smooth glide.'},
    ],
    svg:(s)=>{
      const ul=document.getElementById('upperLip'),ll=document.getElementById('lowerLip'),tp=document.getElementById('tonguePath'),hl=document.getElementById('highlightCircle');
      if(s===0){
        tp.setAttribute('d','M80 160 Q106 143 134 143 Q157 146 163 160 L163 170 Q155 176 134 176 Q106 176 80 170 Z');
        ul.setAttribute('d','M90 196 Q120 190 150 196 Q120 202 90 196');
        ll.setAttribute('d','M90 204 Q120 200 150 204 Q150 215 120 218 Q90 215 90 204');
        hl.setAttribute('cx',120);hl.setAttribute('cy',160);
      } else if(s===1){
        tp.setAttribute('d','M80 178 Q102 172 132 172 Q155 172 162 180 L162 190 Q154 195 132 195 Q102 195 80 190 Z');
        ul.setAttribute('d','M86 196 Q120 184 154 196 Q120 206 86 196');
        ll.setAttribute('d','M86 206 Q120 198 154 206 Q154 222 120 226 Q86 222 86 206');
        hl.setAttribute('cx',120);hl.setAttribute('cy',206);
      } else {
        tp.setAttribute('d','M80 168 Q102 152 130 153 Q154 154 162 167 L162 177 Q154 183 130 183 Q102 183 80 177 Z');
        ul.setAttribute('d','M104 197 Q120 192 136 197 Q120 203 104 197');
        ll.setAttribute('d','M104 205 Q120 201 136 205 Q136 213 120 216 Q104 213 104 205');
        hl.setAttribute('cx',120);hl.setAttribute('cy',205);
      }
      hl.setAttribute('opacity','0.8');
    }
  },
  tone3:{
    tag:'Tone Error Â· 3rd Tone',title:'Dip-Rise ä¸Šè² (214)',
    sub:'Start mid (2), dip to low (1), then rise to high (4).',
    videoTitle:'3rd Tone Dip-Rise â€” Tone Tutorial',
    videoSrc:'https://www.youtube.com/embed/n_Cj3aOSI1w?start=189',
    steps:[
      {title:'Start Mid â€” Pitch Level 2',text:'Begin at a relaxed mid-low pitch. Many learners start too high. The 3rd tone starts low-mid, not high.'},
      {title:'Dip Deeply to Level 1',text:'Drop your pitch to the lowest comfortable point. Feel the larynx descend. This deep dip is the defining feature of the 3rd tone. Most learner errors skip this dip entirely.'},
      {title:'Rise to Level 4 (High)',text:'After the dip, push pitch upward energetically. In natural speech the rise may be abbreviated â€” but the dip must always be present. Practise slowly then speed up.'},
    ],
    svg:(s)=>{
      const tp=document.getElementById('tonguePath'),hl=document.getElementById('highlightCircle');
      if(s===0){tp.setAttribute('d','M80 166 Q102 149 132 149 Q156 149 162 163 L162 173 Q155 178 132 178 Q102 178 80 173 Z');hl.setAttribute('cx',120);hl.setAttribute('cy',90);}
      else if(s===1){tp.setAttribute('d','M80 172 Q102 160 132 160 Q156 160 162 170 L162 180 Q155 184 132 184 Q102 184 80 180 Z');hl.setAttribute('cx',120);hl.setAttribute('cy',210);}
      else{tp.setAttribute('d','M80 162 Q102 144 132 144 Q156 144 162 158 L162 168 Q155 174 132 174 Q102 174 80 168 Z');hl.setAttribute('cx',120);hl.setAttribute('cy',88);}
    }
  },
  xsh:{
    tag:'Initial Error Â· x vs. sh',title:'x (palatal) vs. sh (retroflex)',
    sub:'Tongue blade position determines everything',
    videoTitle:'x vs. sh: Tongue Position (5:47)',
    steps:[
      {title:'For "x" â€” Blade Forward',text:'Place the tongue BLADE (not the tip) just behind the upper front teeth. The tongue tip must rest against lower teeth. Hissing friction from the front of the mouth.'},
      {title:'For "sh" â€” Tip Curled Back',text:'Curl the tongue TIP upward and slightly backward toward the hard palate. Do not touch â€” just approach. Friction from mid-mouth, not the front.'},
      {title:'Practice the Contrast',text:'Alternate slowly: "xi â€” shi â€” xi â€” shi." Feel the tongue tip moving: flat-forward for x, curled-back for sh. Use a mirror to confirm the position difference.'},
    ],
    svg:(s)=>{
      const tp=document.getElementById('tonguePath'),tt=document.getElementById('tongueTip'),af=document.getElementById('airFlow'),hl=document.getElementById('highlightCircle');
      af.setAttribute('opacity','1');
      if(s===0){tp.setAttribute('d','M80 168 Q106 146 136 148 Q158 148 163 163 L163 173 Q157 178 136 178 Q106 178 80 175 Z');tt.setAttribute('cx',87);tt.setAttribute('cy',170);hl.setAttribute('cx',100);hl.setAttribute('cy',148);}
      else if(s===1){tp.setAttribute('d','M80 174 Q98 168 118 146 Q138 136 152 146 Q162 156 163 166 L163 178 Q155 182 132 182 Q100 182 80 178 Z');tt.setAttribute('cx',118);tt.setAttribute('cy',146);hl.setAttribute('cx',126);hl.setAttribute('cy',138);}
      else{tp.setAttribute('d','M80 170 Q102 153 130 151 Q155 151 163 164 L163 174 Q155 180 130 180 Q102 180 80 175 Z');tt.setAttribute('cx',85);tt.setAttribute('cy',170);hl.setAttribute('cx',104);hl.setAttribute('cy',152);}
    }
  },
  uuml:{
    tag:'Vowel Error Â· Ã¼e',title:'The Ã¼e Vowel: Lip Rounding Control',
    sub:'Say â€œee" (i), then round your lips without moving your tongue.',
    videoTitle:'The Ã¼e Vowel: Perfect Roundness (6:15)',
    steps:[
      {title:'Step 1 â€” Set Tongue for "ee"',text:'Position tongue high and forward, as if saying "ee" (yÄ«). The tongue body is raised toward the hard palate. This is the correct tongue position for Ã¼.'},
      {title:'Step 2 â€” Round Your Lips Tightly',text:'While holding the "ee" tongue position without moving it, round your lips into a small tight circle â€” like puckering to whistle. Aperture should be roughly 8â€“10mm wide.'},
      {title:'Step 3 â€” Mirror Check',text:'Look in a mirror. If you can see your upper front teeth, your lips are not rounded enough. The correct Ã¼ has lips fully pursed â€” only a tiny oval opening visible.'},
    ],
    svg:(s)=>{
      const ul=document.getElementById('upperLip'),ll=document.getElementById('lowerLip'),tp=document.getElementById('tonguePath'),hl=document.getElementById('highlightCircle');
      hl.setAttribute('cx',120);hl.setAttribute('cy',204);
      if(s===0){ul.setAttribute('d','M90 196 Q120 190 150 196 Q120 202 90 196');ll.setAttribute('d','M90 204 Q120 200 150 204 Q150 215 120 218 Q90 215 90 204');tp.setAttribute('d','M80 160 Q106 143 134 143 Q157 146 163 160 L163 170 Q155 176 134 176 Q106 176 80 170 Z');}
      else if(s===1){ul.setAttribute('d','M103 197 Q120 191 137 197 Q120 203 103 197');ll.setAttribute('d','M103 205 Q120 201 137 205 Q137 213 120 215 Q103 213 103 205');tp.setAttribute('d','M80 160 Q106 143 134 143 Q157 146 163 160 L163 170 Q155 176 134 176 Q106 176 80 170 Z');}
      else{ul.setAttribute('d','M108 197 Q120 192 132 197 Q120 202 108 197');ll.setAttribute('d','M108 205 Q120 202 132 205 Q132 211 120 213 Q108 211 108 205');tp.setAttribute('d','M80 160 Q106 143 134 143 Q157 146 163 160 L163 170 Q155 176 134 176 Q106 176 80 170 Z');}
    }
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentAnat = null, anatStep = 0;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLOW STEPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setFlowStep(n) {
  for (let i = 1; i <= 5; i++) {
    const el = document.getElementById('fstep' + i);
    if (!el) continue;
    el.classList.remove('active','done');
    if (i < n)      el.classList.add('done');
    else if (i === n) el.classList.add('active');
  }
}

function handleUpload(input) {
  if (!input.files || !input.files[0]) return;
  const file = input.files[0];
  const zone = document.getElementById('uploadZone');
  zone.innerHTML = `
    <div class="upload-icon" style="background:rgba(79,142,247,0.2)">
      <svg viewBox="0 0 24 24" style="width:24px;height:24px;stroke:var(--accent2);fill:none;stroke-width:1.5">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    </div>
    <div class="upload-title">${file.name}</div>
    <div class="upload-sub">${(file.size/1024/1024).toFixed(2)} MB Â· Queued for AI analysis</div>`;
  setFlowStep(2);
  setTimeout(runProcessing, 400);
}

function runDemo() {
  setFlowStep(2);
  document.getElementById('upload-section').scrollIntoView({behavior:'smooth'});
  const zone = document.getElementById('uploadZone');
  zone.innerHTML = `
    <div class="upload-icon" style="background:rgba(79,142,247,0.2)">
      <svg viewBox="0 0 24 24" style="width:24px;height:24px;stroke:var(--accent2);fill:none;stroke-width:1.5">
        <polyline points="20 6 9 17 4 12"/>
      </svg>
    </div>
    <div class="upload-title">demo_pronunciation.wav</div>
    <div class="upload-sub">3.2 MB Â· Running demo analysis</div>`;
  setTimeout(runProcessing, 600);
}

function runProcessing() {
  const ov = document.getElementById('processingOverlay');
  ov.classList.add('visible');
  const ids    = ['ps1','ps2','ps3','ps4','ps5','ps6'];
  const delays = [0, 750, 1500, 2250, 3000, 3750];
  ids.forEach((id, i) => {
    setTimeout(() => {
      document.getElementById(id).classList.add('visible','active');
      if (i > 0) {
        document.getElementById(ids[i-1]).classList.remove('active');
        document.getElementById(ids[i-1]).classList.add('done');
      }
    }, delays[i]);
  });
  setTimeout(() => {
    document.getElementById(ids[ids.length-1]).classList.remove('active');
    document.getElementById(ids[ids.length-1]).classList.add('done');
    setTimeout(() => { ov.classList.remove('visible'); showResults(); }, 500);
  }, 4600);
}

function showResults() {
  /* â€” Dynamic score (60-95) + CEFR â€” */
  const dynamicScore = Math.floor(Math.random() * 36) + 60;
  const cefr         = scoreToLevel(dynamicScore);

  // Update ring score text
  const ringText = document.getElementById('ringScoreText');
  if (ringText) ringText.textContent = dynamicScore;

  // Update CEFR badge
  const cefrEl = document.getElementById('cefrBadge');
  if (cefrEl) {
    cefrEl.textContent   = cefr.level + ' â€” ' + cefr.label;
    cefrEl.style.background   = cefr.color + '22';
    cefrEl.style.color        = cefr.color;
    cefrEl.style.borderColor  = cefr.color + '55';
  }

  // Target sentence
  const tse = document.getElementById('targetSentenceText');
  if (tse && sttRecognized) tse.textContent = sttRecognized;

  // Build syllables from STT or fallback
  currentSyllables = sttRecognized ? buildSyllablesFromSTT(sttRecognized) : SYLLABLES;

  /* â€” Pitch contour section â€” */
  setFlowStep(3);
  const pitchData = sttRecognized ? buildPitchDataFromSyllables(currentSyllables) : SENTENCE_PITCH;
  buildContourCards(pitchData);
  const cs = document.getElementById('contourSection');
  cs.classList.add('visible');
  cs.scrollIntoView({behavior:'smooth', block:'start'});

  /* â€” Score breakdown section â€” */
  setTimeout(() => {
    setFlowStep(4);
    document.getElementById('scoreBreakdownSection').classList.add('visible');
    setTimeout(() => animateScoreRing(dynamicScore), 200);

    // Randomised sub-scores (plausible range)
    const sfPct  = Math.floor(Math.random() * 20) + 72;
    const iniPct = Math.floor(Math.random() * 20) + 58;
    const cfPct  = Math.floor(Math.random() * 22) + 60;
    const tPct   = Math.floor(Math.random() * 24) + 48;
    setTimeout(() => {
      [['bar-sf', sfPct+'%'],['bar-ini', iniPct+'%'],['bar-cf', cfPct+'%'],['bar-t', tPct+'%']].forEach(([id,w]) => {
        const el = document.getElementById(id);
        if (el) { el.style.width = '0'; setTimeout(() => { el.style.width = w; }, 100); }
      });
    }, 300);
  }, 800);

  /* â€” Results / Breakdown section â€” */
  setTimeout(() => {
    setFlowStep(5);
    buildErrorSummary(currentSyllables);
    buildUtterance(currentSyllables);
    document.getElementById('resultsSection').classList.add('visible');
    document.querySelectorAll('.tone-bar-fill').forEach(b => {
      const w = b.dataset.w; b.style.width = '0';
      setTimeout(() => { b.style.width = w; }, 350);
    });
  }, 1800);

  /* â€” Video intervention â€” */
  setTimeout(() => {
    const vs = document.getElementById('videoSection');
    if (vs) vs.classList.add('visible');

    const toneErr    = currentSyllables.find(s => s.type === 'tone-error');
    const initialErr = currentSyllables.find(s => s.type === 'initial-error');
    const vowelErr   = currentSyllables.find(s => s.type === 'vowel-error');

    if (toneErr) {
      updateVideoIntervention('tone', 3);
    } else if (initialErr) {
      const ini = extractInitial(initialErr.pinyin) || 'x';
      updateVideoIntervention('initial', ini);
    } else if (vowelErr) {
      updateVideoIntervention('simpleFinal', 'Ã¼');
    } else {
      // Perfect pronunciation â€” show encouraging tone overview
      const iframe  = document.getElementById('ytPlayer');
      const caption = document.getElementById('videoCaption');
      const ph      = document.getElementById('ytPlaceholder');
      if (iframe)  iframe.src = `https://www.youtube.com/embed/n_Cj3aOSI1w?start=0&autoplay=0`;
      if (caption) caption.textContent = 'Outstanding! Review all tones to maintain your excellent level.';
      if (ph)      ph.style.display = 'none';
    }
  }, 2600);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCORE RING ANIMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function animateScoreRing(score) {
  const ring         = document.getElementById('ringFill');
  const circumference = 251.2;
  ring.style.strokeDashoffset = circumference - (score / 100) * circumference;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GENERATE PITCH DATA FROM SYLLABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildPitchDataFromSyllables(syllables) {
  const NATIVE_CURVES = {
    0: [.44,.43,.43,.42,.42,.42,.41,.41],
    1: [.82,.82,.82,.82,.82,.82,.82,.82],
    2: [.28,.38,.50,.62,.72,.82,.88,.93],
    3: [.55,.38,.18,.10,.08,.25,.52,.72],
    4: [.92,.82,.68,.52,.40,.28,.18,.10],
  };
  function toneFromPinyin(p) {
    if (/[ÄÅÄ“Ä«Å«Ç–]/.test(p)) return 1;
    if (/[Ã¡Ã³Ã©Ã­ÃºÇ˜]/.test(p)) return 2;
    if (/[ÇÇ’Ä›ÇÇ”Çš]/.test(p)) return 3;
    if (/[Ã Ã²Ã¨Ã¬Ã¹Çœ]/.test(p)) return 4;
    return 0;
  }
  function clamp(v) { return Math.min(1, Math.max(0.05, v)); }
  function buildUserCurve(native, type) {
    if (type === 'tone-error')
      return native.map(v => clamp(v * 0.35 + 0.42 + (Math.random() - 0.5) * 0.06));
    if (type === 'initial-error' || type === 'vowel-error')
      return native.map(v => clamp(v + (Math.random() - 0.5) * 0.10));
    return native.map(v => clamp(v + (Math.random() - 0.5) * 0.04));
  }
  return syllables.map(s => {
    const tone   = toneFromPinyin(s.pinyin);
    const native = (NATIVE_CURVES[tone] || NATIVE_CURVES[0]).slice();
    const user   = buildUserCurve(native, s.type);
    const error  = s.type !== 'correct' ? s.type : undefined;
    return { char: s.char, pinyin: s.pinyin, tone, native, user, error };
  });
}

/* â•â•â• FULL-SENTENCE PITCH CONTOUR CANVAS â•â•â• */
function buildContourCards(pitchData) {
  const grid = document.getElementById('contourGrid');
  const sentenceTitle = (pitchData || SENTENCE_PITCH).map(d => d.char).join('');
  grid.innerHTML = `
    <div class="contour-card" style="grid-column:1/-1">
      <div class="contour-header">
        <div style="font-family:'Noto Serif SC',serif;font-size:20px;font-weight:700;color:var(--text);letter-spacing:3px">
          ${sentenceTitle}
        </div>
        <div class="contour-meta">
          <div class="contour-pinyin">Full Sentence â€” F0 Pitch Contour</div>
        </div>
      </div>
      <div class="contour-canvas-wrap" style="padding:20px 24px 8px">
        <canvas id="cv_full" width="900" height="160" style="width:100%;height:160px;display:block"></canvas>
      </div>
      <div class="contour-legend" style="padding:0 24px 18px;gap:24px">
        <div class="legend-item">
          <svg width="32" height="14" style="vertical-align:middle;margin-right:4px">
            <line x1="0" y1="7" x2="32" y2="7" stroke="#008080" stroke-width="2.5"/>
            <circle cx="8"  cy="7" r="3" fill="white" stroke="#008080" stroke-width="1.5"/>
            <circle cx="16" cy="7" r="3" fill="white" stroke="#008080" stroke-width="1.5"/>
            <circle cx="24" cy="7" r="3" fill="white" stroke="#008080" stroke-width="1.5"/>
          </svg>
          <span style="font-size:11px;color:var(--text2)">Native target</span>
        </div>
        <div class="legend-item">
          <svg width="32" height="14" style="vertical-align:middle;margin-right:4px">
            <line x1="0" y1="7" x2="32" y2="7" stroke="#FF4500" stroke-width="2" stroke-dasharray="6,4"/>
          </svg>
          <span style="font-size:11px;color:var(--text2)">Your recording</span>
        </div>
        <div class="legend-item" style="margin-left:auto;font-size:11px;color:var(--text3)">
          <span style="display:inline-block;width:10px;height:10px;background:rgba(245,158,11,0.25);border:1px solid #f59e0b;border-radius:2px;margin-right:4px"></span>Initial error &nbsp;
          <span style="display:inline-block;width:10px;height:10px;background:rgba(59,130,246,0.20);border:1px solid #3b82f6;border-radius:2px;margin-right:4px"></span>Compound error &nbsp;
          <span style="display:inline-block;width:10px;height:10px;background:rgba(255,69,0,0.20);border:1px solid #FF4500;border-radius:2px;margin-right:4px"></span>Tone error
        </div>
      </div>
    </div>`;
  requestAnimationFrame(() => drawFullSentenceContour(pitchData));
}

function drawFullSentenceContour(pitchData) {
  const data   = pitchData || SENTENCE_PITCH;
  const canvas = document.getElementById('cv_full');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  // Scale canvas for retina
  const dpr = window.devicePixelRatio || 1;
  const cssW = canvas.offsetWidth || 900;
  const cssH = 160;
  canvas.width  = cssW * dpr;
  canvas.height = cssH * dpr;
  ctx.scale(dpr, dpr);

  const W = cssW, H = cssH;
  const PT = 20, PB = 36, PL = 32, PR = 56;
  const iW = W - PL - PR, iH = H - PT - PB;
  const N  = data.length;
  const STEP = iW / N;   // one column per syllable

  ctx.clearRect(0, 0, W, H);

  // Background error zones
  data.forEach((d, i) => {
    if (!d.error) return;
    const x0 = PL + i * STEP;
    const col = d.error === 'initial-error'  ? 'rgba(245,158,11,0.12)' :
                d.error === 'compound-error' ? 'rgba(59,130,246,0.12)' :
                                               'rgba(255,69,0,0.12)';
    const bdr = d.error === 'initial-error'  ? '#f59e0b' :
                d.error === 'compound-error' ? '#3b82f6' : '#FF4500';
    ctx.fillStyle = col;
    ctx.fillRect(x0, PT, STEP, iH);
    ctx.strokeStyle = bdr.replace(')', ',0.4)').replace('rgb','rgba');
    ctx.lineWidth = 1; ctx.setLineDash([3,3]);
    ctx.strokeRect(x0, PT, STEP, iH);
    ctx.setLineDash([]);
  });

  // Horizontal grid lines (pitch levels 1-5)
  ['5','4','3','2','1'].forEach((lbl, i) => {
    const y = PT + (iH / 4) * i;
    ctx.strokeStyle = 'rgba(30,41,59,0.07)'; ctx.lineWidth = 1; ctx.setLineDash([]);
    ctx.beginPath(); ctx.moveTo(PL, y); ctx.lineTo(W - PR, y); ctx.stroke();
    ctx.fillStyle = 'rgba(30,41,59,0.30)';
    ctx.font = '9px Inter,sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(lbl, PL - 5, y + 3.5);
  });

  // Syllable column separators + labels
  ctx.textAlign = 'center';
  data.forEach((d, i) => {
    const cx = PL + i * STEP + STEP / 2;
    // separator
    ctx.strokeStyle = 'rgba(30,41,59,0.06)'; ctx.lineWidth = 1; ctx.setLineDash([2,4]);
    ctx.beginPath(); ctx.moveTo(PL + i * STEP, PT); ctx.lineTo(PL + i * STEP, PT + iH); ctx.stroke();
    ctx.setLineDash([]);
    // Chinese character label
    ctx.font = '14px "Noto Serif SC",serif';
    ctx.fillStyle = d.error ? (
      d.error === 'initial-error'  ? '#f59e0b' :
      d.error === 'compound-error' ? '#3b82f6' : '#FF4500'
    ) : 'rgba(30,41,59,0.6)';
    ctx.fillText(d.char, cx, PT + iH + 16);
    // pinyin (tone number)
    ctx.font = '8px Inter,sans-serif';
    ctx.fillStyle = 'rgba(30,41,59,0.35)';
    ctx.fillText(d.tone, cx, PT + iH + 26);
  });

  // Build flat point arrays: one representative point per syllable (mid-value of 8 samples)
  function midPt(arr) { return (arr[3] + arr[4]) / 2; }
  function allPts(key) {
    const pts = [];
    data.forEach((d, i) => {
      // Use 3 points per syllable for smoother curve: start, mid, end
      [0, 3, 7].forEach((si, j) => {
        const x = PL + (i + (si / 7)) * STEP;
        const y = PT + iH - d[key][si] * iH;
        pts.push({x, y});
      });
    });
    return pts;
  }

  const nPts = allPts('native');
  const uPts = allPts('user');

  // Native fill (teal)
  ctx.beginPath();
  nPts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
  ctx.lineTo(nPts[nPts.length-1].x, PT + iH);
  ctx.lineTo(nPts[0].x, PT + iH);
  ctx.closePath();
  ctx.fillStyle = 'rgba(0,128,128,0.08)';
  ctx.fill();

  // Native line (solid teal)
  ctx.beginPath();
  nPts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = '#008080'; ctx.lineWidth = 2.5;
  ctx.lineJoin = 'round'; ctx.lineCap = 'round'; ctx.setLineDash([]);
  ctx.stroke();

  // Native data-point markers: open circles at each sample point
  nPts.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
    ctx.strokeStyle = '#008080'; ctx.lineWidth = 1.5; ctx.setLineDash([]);
    ctx.fillStyle = '#ffffff';
    ctx.fill();
    ctx.stroke();
  });

  // User line (dashed red-orange)
  ctx.beginPath();
  uPts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
  ctx.strokeStyle = '#FF4500'; ctx.lineWidth = 2; ctx.setLineDash([6, 4]);
  ctx.lineJoin = 'round'; ctx.lineCap = 'round';
  ctx.stroke();
  ctx.setLineDash([]);

  // Direct end-of-line labels
  const lastN = nPts[nPts.length - 1];
  const lastU = uPts[uPts.length - 1];
  ctx.font = 'bold 9px Inter,sans-serif'; ctx.textAlign = 'left';
  ctx.fillStyle = '#008080';
  ctx.fillText('Native', lastN.x + 5, lastN.y + 3.5);
  ctx.fillStyle = '#FF4500';
  ctx.fillText('You', lastU.x + 5, lastU.y + 3.5);

  // Error dots
  data.forEach((d, i) => {
    if (!d.error) return;
    const cx = PL + (i + 0.5) * STEP;
    const ny = PT + iH - midPt(d.native) * iH;
    const uy = PT + iH - midPt(d.user)   * iH;
    // deviation line
    ctx.strokeStyle = 'rgba(255,69,0,0.5)'; ctx.lineWidth = 1.5; ctx.setLineDash([3,3]);
    ctx.beginPath(); ctx.moveTo(cx, Math.min(ny,uy)); ctx.lineTo(cx, Math.max(ny,uy)); ctx.stroke();
    ctx.setLineDash([]);
    // label
    ctx.font = 'bold 9px Inter,sans-serif'; ctx.textAlign = 'center';
    ctx.fillStyle = '#FF4500';
    ctx.fillText('!', cx, Math.min(ny,uy) - 4);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTTERANCE DISPLAY (with coloured Pinyin)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildUtterance(syllables) {
  syllables = syllables || currentSyllables;
  const container = document.getElementById('utteranceDisplay');
  container.innerHTML = '';

  syllables.forEach((s, idx) => {
    const el = document.createElement('div');
    el.className = `syllable-unit ${s.type}`;

    // Coloured pinyin â€” structural highlighting
    const coloredPinyin = renderPinyinColored(s.pinyin);

    el.innerHTML = `
      <div class="syl-char">${s.char}</div>
      <div class="syl-pinyin">${coloredPinyin}</div>
      <div class="syl-tooltip">${s.tooltip}</div>`;

    // Click: open anatomy guide + load targeted video (NO autoplay)
    if (s.videoSrc) {
      el.style.cursor = 'pointer';
      el.onclick = () => {
        // Load video without autoplay
        const iframe  = document.getElementById('ytPlayer');
        const caption = document.getElementById('videoCaption');
        const ph      = document.getElementById('ytPlaceholder');
        if (iframe)  { iframe.src = s.videoSrc; iframe.style.opacity = '1'; }
        if (ph)      ph.style.display = 'none';
        if (caption) caption.textContent = s.videoLabel || 'Targeted tutorial loaded.';
        // Open anatomy guide + update inline card
        if (s.anatomyKey && ANATOMY[s.anatomyKey]) { openAnatomy(s.anatomyKey); updateAicCard(s.anatomyKey); }
        // Show video section and scroll
        const vs = document.getElementById('videoSection');
        if (vs) { vs.classList.add('visible'); setTimeout(()=>vs.scrollIntoView({behavior:'smooth'}), 50); }
      };
    }

    el.style.cssText = 'opacity:0;transform:translateY(10px);transition:opacity .35s ease,transform .35s ease;';
    container.appendChild(el);
    setTimeout(() => { el.style.opacity='1'; el.style.transform='translateY(0)'; }, idx * 70);
  });
}

/* â•â•â• ANATOMY MODAL â•â•â• */
function openAnatomy(key){
  if (!ANATOMY[key]) return;
  currentAnat=ANATOMY[key]; anatStep=0;
  document.getElementById('modalTag').textContent=currentAnat.tag;
  document.getElementById('modalTitle').textContent=currentAnat.title;
  document.getElementById('modalSub').textContent=currentAnat.sub;
  document.getElementById('modalVideoTitle').textContent=currentAnat.videoTitle;
  // Wire up modal video link
  const mvl = document.querySelector('.modal-video-link');
  if (mvl && currentAnat.videoSrc) {
    mvl.onclick = (e) => {
      e.preventDefault();
      const iframe  = document.getElementById('ytPlayer');
      const caption = document.getElementById('videoCaption');
      const ph      = document.getElementById('ytPlaceholder');
      const vs      = document.getElementById('videoSection');
      if (iframe)  { iframe.src = currentAnat.videoSrc; iframe.style.opacity='1'; }
      if (ph)      ph.style.display = 'none';
      if (caption) caption.textContent = currentAnat.videoTitle;
      if (vs)      vs.classList.add('visible');
      closeAnatomy();
      setTimeout(()=>vs.scrollIntoView({behavior:'smooth'}), 100);
    };
  }
  renderAnatSteps();
  document.getElementById('anatomyModal').classList.add('visible');
  document.body.style.overflow='hidden';
}
function closeAnatomy(){
  document.getElementById('anatomyModal').classList.remove('visible');
  document.body.style.overflow='';
  document.getElementById('airFlow').setAttribute('opacity','0');
  document.getElementById('highlightCircle').setAttribute('opacity','0');
}
function renderAnatSteps(){
  const container=document.getElementById('anatomySteps');
  container.innerHTML='';
  currentAnat.steps.forEach((s,i)=>{
    const el=document.createElement('div');
    el.className=`anat-step ${i===anatStep?'active':''}`;
    el.innerHTML=`<div class="anat-num">${i+1}</div><div class="anat-text"><div class="anat-title">${s.title}</div>${s.text}</div>`;
    el.onclick=()=>{anatStep=i;renderAnatSteps();};
    container.appendChild(el);
  });
  document.getElementById('stepIndicator').textContent=`${anatStep+1} / ${currentAnat.steps.length}`;
  document.getElementById('highlightCircle').setAttribute('opacity','0.8');
  if(currentAnat.svg) currentAnat.svg(anatStep);
}
function nextAnatStep(){if(!currentAnat) return; anatStep=Math.min(anatStep+1,currentAnat.steps.length-1); renderAnatSteps();}
function prevAnatStep(){if(!currentAnat) return; anatStep=Math.max(anatStep-1,0); renderAnatSteps();}
function loadTargetedVideo(src, label) {
  const iframe  = document.getElementById('ytPlayer');
  const ph      = document.getElementById('ytPlaceholder');
  const caption = document.getElementById('videoCaption');
  const vs      = document.getElementById('videoSection');
  if (iframe)  { iframe.src = src; iframe.style.opacity = '1'; }
  if (ph)      ph.style.display = 'none';
  if (caption) caption.textContent = label;
  if (vs)      { vs.classList.add('visible'); setTimeout(()=>vs.scrollIntoView({behavior:'smooth'}), 50); }
}
/* Cards: video + anatomy key mapping */
var CARD_MAP = [
  {fb:'fbNeng', ab:'abNeng', vb:'btnNeng', akey:'tone2', src:'https://www.youtube.com/embed/n_Cj3aOSI1w?start=433', label:'2nd Tone Rising â€” neng (n\u00e9ng)'},
  {fb:'fbXing', ab:'abXing', vb:'btnXing', akey:'xsh',   src:'https://www.youtube.com/embed/05BMKdxHjp8?start=33',  label:'Initial x Position â€” xing (x\u012bng)'},
  {fb:'fbXiao', ab:'abXiao', vb:'btnXiao', akey:'iao',   src:'https://www.youtube.com/embed/IwXyiWNv1Ts?start=260', label:'-iao Compound Final â€” xiao (xi\u00e0o)'},
];
function initIvpCards() {
  CARD_MAP.forEach(function(c) {
    var fb = document.getElementById(c.fb);
    var ab = document.getElementById(c.ab);
    var vb = document.getElementById(c.vb);
    if (fb) fb.addEventListener('click', function() { updateAicCard(c.akey); });
    if (ab) ab.addEventListener('click', function(e) { e.stopPropagation(); openAnatomy(c.akey); updateAicCard(c.akey); });
    if (vb) vb.addEventListener('click', function(e) { e.stopPropagation(); loadTargetedVideo(c.src, c.label); });
  });
}
function updateAicCard(key) {
  var anat = ANATOMY[key];
  if (!anat) return;
  var tag   = document.getElementById('aicTag');
  var title = document.getElementById('aicTitle');
  var desc  = document.getElementById('aicDesc');
  var hl    = document.getElementById('aicHighlight');
  var af    = document.getElementById('aicAirFlow');
  if (tag)   tag.textContent   = anat.tag;
  if (title) title.textContent = anat.title;
  if (desc && anat.steps.length) {
    var s0 = anat.steps[0];
    desc.innerHTML = '<div class="aic-step-num">Step 1 of ' + anat.steps.length + '</div>'
      + '<div class="aic-step-title">' + s0.title + '</div>'
      + '<div class="aic-step-text">' + s0.text.substring(0, 130) + (s0.text.length > 130 ? '\u2026' : '') + '</div>';
  }
  if (hl) {
    hl.setAttribute('opacity', '0.8');
    var cx = 80, cy = 118;
    if (key === 'xsh')  { cx = 48; cy = 118; if (af) af.setAttribute('opacity','1'); }
    else if (key === 'iao') { cx = 80; cy = 148; }
    else if (key === 'tone2' || key === 'tone3') { cx = 80; cy = 64; }
    hl.setAttribute('cx', cx);
    hl.setAttribute('cy', cy);
  }
  if (af && key !== 'xsh') af.setAttribute('opacity', '0');
}
document.getElementById('anatomyModal').addEventListener('click',e=>{if(e.target===document.getElementById('anatomyModal')) closeAnatomy();});
initIvpCards();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAG & DROP on upload zone
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const uZone = document.getElementById('uploadZone');
if (uZone) {
  uZone.addEventListener('dragover', e => { e.preventDefault(); uZone.style.borderColor = 'var(--accent)'; });
  uZone.addEventListener('dragleave', () => { uZone.style.borderColor = ''; });
  uZone.addEventListener('drop', e => {                                                                                                                                   
    e.preventDefault();
    uZone.style.borderColor = '';
    const dt = e.dataTransfer;
    if (dt.files[0]) handleUpload({ files: dt.files });
  });
}
</script>
</body>
</html>